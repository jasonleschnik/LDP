<!DOCTYPE book  PUBLIC "-//OASIS//DTD DocBook V4.1//EN" []>

<book lang="en"><!-- DocBook file was created by LyX 1.2
  See http://www.lyx.org/ for more information -->
<bookinfo><title>SSL Certificates HOWTO</title><date>V0.5 20 October 2002 </date><author><firstname>Franck</firstname><surname>Martin</surname></author><revhistory>
<revision>
<revnumber>v0.5</revnumber>
<date>2002-10-20</date>
<authorinitials>FM</authorinitials>
<revremark>Adding IPsec information from Nate Carlson, natecars@natecarlson.com / Adding IMAPS and POPS information from Bill Shirley, webnut@telocity.com / Adding WinCrypt information from Colin McKinnon, colin@wew.co.uk</revremark>
</revision>
<revision>
<revnumber>v0.4</revnumber>
<date>2002-06-22</date>
<authorinitials>FM</authorinitials>
<revremark>Various corrections - adding ASCII Art</revremark>
</revision>
<revision>
<revnumber>v0.3</revnumber>
<date>2002-05-09</date>
<authorinitials>FM</authorinitials>
<revremark>Adding x509v3 extension information - Correcting spelling</revremark>
</revision>
<revision>
<revnumber>v0.2</revnumber>
<date>2001-12-06</date>
<authorinitials>FM</authorinitials>
<revremark>Adding openssl.cnf file / Adding CRL info from Averroes, a.averroes@libertysurf.fr / Correcting spelling</revremark>
</revision>
<revision>
<revnumber>v0.1</revnumber>
<date>2001-11-18</date>
<authorinitials>FM</authorinitials>
<revremark>Creation of the HOWTO</revremark>
</revision>
</revhistory>
<abstract><para>A first hand approach on how to manage a certificate authority (CA), and issue or sign certificates to be used for secure web, secure e-mail, or signing code and other usages.</para></abstract></bookinfo>
<chapter><title>Generalities</title><sect1><title>Introduction</title><para>Dear reader, like myself, you have intensively read the man pages of the applications of the <ulink url="http://www.openssl.org/">OpenSSL</ulink> project, and like myself, you couldn't figure out where to start, and how to work securely with certificates. Here is the answer to most of your questions.</para><para>This HOWTO will also deal with non-linux applications: there is no use to issue certificates if you can't use them... All applications won't be listed here, but please, send me additional paragraphs and corrections. I can be reached at the following address:<ulink url="mailto: franck@sopac.org">franck@sopac.org</ulink>.</para><para>This HOWTO is published on <ulink url="http://www.tldp.org/">The Linux Documentation Project</ulink> this is where you will find the lastest version of this document.</para><sect2><title>Disclaimer and Licence</title><para>This document is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</para><para>In short, if the advises given here break the security of your e-commerce application, then tough luck- it's never our fault. Sorry.</para><para>Copyright (c) 2001 by Franck Martin and others from the openssl-users mailing list under GFDL (the <ulink url="http://www.gnu.org/">GNU</ulink> Free Documentation License).</para><para>Please freely copy and distribute (sell or give away) this document in any format. It's requested that corrections and/or comments be forwarded to the document maintainer. You may create a derivative work and distribute it provided that you:</para><orderedlist><listitem><para>Send your derivative work (in the most suitable format such as sgml) to the LDP (Linux Documentation Project) or the like for posting on the Internet. If not the LDP, then let the LDP know where it is available. </para></listitem><listitem><para>License the derivative work with this same license or use GPL. Include a copyright notice and at least a pointer to the license used. </para></listitem><listitem><para>Give due credit to previous authors and major contributors. If you're considering making a derived work other than a translation, it's requested that you discuss your plans with the current maintainer.</para></listitem></orderedlist><para>It is also requested that if you publish this HOWTO in hardcopy that you send the authors some samples for 'review purposes' :-). You may also want to send something to cook my noodles ;-)</para></sect2>
<sect2><title>Prior knowledge</title><para>As indicated in the introduction, this documents is an hand-on HOWTO, and it is therefore required that you consult the man pages of the OpenSSL software. You should as well read security books to learn how your security could be compromised. Certificates are meant to increase the security of your transactions, it is VERY important that you understand all the security implications of your actions and what security OpenSSL does not provide.</para></sect2>
</sect1>
<sect1><title>What is SSL and what are Certificates?</title><para>The Secure Socket Layer protocol was created by Netscape to ensure secure transactions between web servers and browsers. The protocol uses a third party, a Certificate Authority (CA), to identify one end or both end of the transactions. This is in short how it works. </para><orderedlist><listitem><para>A browser requests a secure page (usually https://).</para></listitem><listitem><para>The web server sends its public key with its certificate.</para></listitem><listitem><para>The browser checks that the certificate was issued by a trusted party (usually a trusted root CA), that the certificate is still valid and that the certificate is related to the site contacted.</para></listitem><listitem><para>The browser then uses the public key, to encrypt a random symmetric encryption key and sends it to the server with the encrypted URL required as well as other encrypted http data.</para></listitem><listitem><para>The web server decrypts the symmetric encryption key using its private key and uses the symmetric key to decrypt the URL and http data. </para></listitem><listitem><para>The web server sends back the requested html document and http data encrypted with the symmetric key. </para></listitem><listitem><para>The browser decrypts the http data and html document using the symmetric key and displays the information.</para></listitem></orderedlist><para>Several concepts have to be understood here.</para><sect2><title>Private Key/Public Key:</title><para>The encryption using a private key/public key pair ensures that the data can be encrypted by one key but can only be decrypted by the other key pair. This is sometime hard to understand, but believe me it works. The keys are similar in nature and can be used alternatively: what one key encrypts, the other key pair can decrypt. The key pair is based on prime numbers and their length in terms of bits ensures the difficulty of being able to decrypt the message without the key pairs. The trick in a key pair is to keep one key secret (the private key) and to distribute the other key (the public key) to everybody. Anybody can send you an encrypted message, that only you will be able to decrypt. You are the only one to have the other key pair, right? In the opposite , you can certify that a message is only coming from you, because you have encrypted it with you private key, and only the associated public key will decrypt it correctly. Beware, in this case the message is not secured you have only signed it. Everybody has the public key, remember!</para><para>The problem left is to know the public key of your correspondent. Usually you will ask him to send you a non confidential signed message that will contains his publick key as well as a certificate.</para><programlisting><![CDATA[Message-->[Public Key]-->Encrypted Message-->[Private Key]-->Message
]]></programlisting></sect2>
<sect2><title>The Certificate:</title><para>How do you know that you are dealing with the right person or rather the right web site. Well, someone has taken great length (if they are serious) to ensure that the web site owners are who they claim to be. This someone, you have to implicitly trust: you have his/her certificate loaded in your browser (a root Certificate). A certificate, contains information about the owner of the certificate, like e-mail address, owner's name, certificate usage, duration of validity, resource location or Distinguished Name (DN) which includes the Common Name (CN) (web site address or e-mail address depending of the usage) and the certificate ID of the person who certifies (signs) this information. It contains also the public key and finally a hash to ensure that the certificate has not been tampered with. As you made the choice to trust the person who signs this certificate, therefore you also trust this certificate. This is a certificate trust tree or certificate path. Usually your browser or application has already loaded the root certificate of well known Certification Authorities (CA) or root CA Certificates. The CA maintains a list of all signed certificates as well as a list of revoked certificates. A certificate is insecure until it is signed, as only a signed certificate cannot be modified. You can sign a certificate using itself, it is called a self signed certificate. All root CA certificates are self signed.</para><programlisting><![CDATA[Certificate: 
]]><![CDATA[    Data: 
]]><![CDATA[        Version: 3 (0x2) 
]]><![CDATA[        Serial Number: 1 (0x1) 
]]><![CDATA[        Signature Algorithm: md5WithRSAEncryption 
]]><![CDATA[        Issuer: C=FJ, ST=Fiji, L=Suva, O=SOPAC, OU=ICT, CN=SOPAC Root CA/Email=administrator@sopac.org 
]]><![CDATA[        Validity 
]]><![CDATA[            Not Before: Nov 20 05:47:44 2001 GMT 
]]><![CDATA[            Not After : Nov 20 05:47:44 2002 GMT 
]]><![CDATA[        Subject: C=FJ, ST=Fiji, L=Suva, O=SOPAC, OU=ICT, CN=www.sopac.org/Email=administrator@sopac.org 
]]><![CDATA[        Subject Public Key Info: 
]]><![CDATA[            Public Key Algorithm: rsaEncryption  
]]><![CDATA[            RSA Public Key: (1024 bit) 
]]><![CDATA[                Modulus (1024 bit): 
]]><![CDATA[                    00:ba:54:2c:ab:88:74:aa:6b:35:a5:a9:c1:d0:5a: 
]]><![CDATA[                    9b:fb:6b:b5:71:bc:ef:d3:ab:15:cc:5b:75:73:36: 
]]><![CDATA[                    b8:01:d1:59:3f:c1:88:c0:33:91:04:f1:bf:1a:b4: 
]]><![CDATA[                    7a:c8:39:c2:89:1f:87:0f:91:19:81:09:46:0c:86: 
]]><![CDATA[                    08:d8:75:c4:6f:5a:98:4a:f9:f8:f7:38:24:fc:bd: 
]]><![CDATA[                    94:24:37:ab:f1:1c:d8:91:ee:fb:1b:9f:88:ba:25: 
]]><![CDATA[                    da:f6:21:7f:04:32:35:17:3d:36:1c:fb:b7:32:9e: 
]]><![CDATA[                    42:af:77:b6:25:1c:59:69:af:be:00:a1:f8:b0:1a: 
]]><![CDATA[                    6c:14:e2:ae:62:e7:6b:30:e9 
]]><![CDATA[                Exponent: 65537 (0x10001) 
]]><![CDATA[         X509v3 extensions: 
]]><![CDATA[             X509v3 Basic Constraints: 
]]><![CDATA[                 CA:FALSE 
]]><![CDATA[             Netscape Comment: 
]]><![CDATA[                 OpenSSL Generated Certificate
]]><![CDATA[             X509v3 Subject Key Identifier:
]]><![CDATA[                 FE:04:46:ED:A0:15:BE:C1:4B:59:03:F8:2D:0D:ED:2A:E0:ED:F9:2F 
]]><![CDATA[             X509v3 Authority Key Identifier:
]]><![CDATA[                 keyid:E6:12:7C:3D:A1:02:E5:BA:1F:DA:9E:37:BE:E3:45:3E:9B:AE:E5:A6 
]]><![CDATA[                 DirName:/C=FJ/ST=Fiji/L=Suva/O=SOPAC/OU=ICT/CN=SOPAC Root CA/Email=administrator@sopac.org 
]]><![CDATA[                 serial:00
]]><![CDATA[
]]><![CDATA[    Signature Algorithm: md5WithRSAEncryption
]]><![CDATA[        34:8d:fb:65:0b:85:5b:e2:44:09:f0:55:31:3b:29:2b:f4:fd: 
]]><![CDATA[        aa:5f:db:b8:11:1a:c6:ab:33:67:59:c1:04:de:34:df:08:57: 
]]><![CDATA[        2e:c6:60:dc:f7:d4:e2:f1:73:97:57:23:50:02:63:fc:78:96: 
]]><![CDATA[        34:b3:ca:c4:1b:c5:4c:c8:16:69:bb:9c:4a:7e:00:19:48:62: 
]]><![CDATA[        e2:51:ab:3a:fa:fd:88:cd:e0:9d:ef:67:50:da:fe:4b:13:c5: 
]]><![CDATA[        0c:8c:fc:ad:6e:b5:ee:40:e3:fd:34:10:9f:ad:34:bd:db:06: 
]]><![CDATA[        ed:09:3d:f2:a6:81:22:63:16:dc:ae:33:0c:70:fd:0a:6c:af:
]]><![CDATA[        bc:5a 
]]><![CDATA[-----BEGIN CERTIFICATE----- 
]]><![CDATA[MIIDoTCCAwqgAwIBAgIBATANBgkqhkiG9w0BAQQFADCBiTELMAkGA1UEBhMCRkox 
]]><![CDATA[DTALBgNVBAgTBEZpamkxDTALBgNVBAcTBFN1dmExDjAMBgNVBAoTBVNPUEFDMQww 
]]><![CDATA[CgYDVQQLEwNJQ1QxFjAUBgNVBAMTDVNPUEFDIFJvb3QgQ0ExJjAkBgkqhkiG9w0B 
]]><![CDATA[CQEWF2FkbWluaXN0cmF0b3JAc29wYWMub3JnMB4XDTAxMTEyMDA1NDc0NFoXDTAy 
]]><![CDATA[MTEyMDA1NDc0NFowgYkxCzAJBgNVBAYTAkZKMQ0wCwYDVQQIEwRGaWppMQ0wCwYD 
]]><![CDATA[VQQHEwRTdXZhMQ4wDAYDVQQKEwVTT1BBQzEMMAoGA1UECxMDSUNUMRYwFAYDVQQD 
]]><![CDATA[Ew13d3cuc29wYWMub3JnMSYwJAYJKoZIhvcNAQkBFhdhZG1pbmlzdHJhdG9yQHNv 
]]><![CDATA[cGFjLm9yZzCBnzANBgkqhkiG9w0BAQEFAAOBjQAwgYkCgYEAulQsq4h0qms1panB 
]]><![CDATA[0Fqb+2u1cbzv06sVzFt1cza4AdFZP8GIwDORBPG/GrR6yDnCiR+HD5EZgQlGDIYI 
]]><![CDATA[2HXEb1qYSvn49zgk/L2UJDer8RzYke77G5+IuiXa9iF/BDI1Fz02HPu3Mp5Cr3e2 
]]><![CDATA[JRxZaa++AKH4sBpsFOKuYudrMOkCAwEAAaOCARUwggERMAkGA1UdEwQCMAAwLAYJ 
]]><![CDATA[YIZIAYb4QgENBB8WHU9wZW5TU0wgR2VuZXJhdGVkIENlcnRpZmljYXRlMB0GA1Ud
]]><![CDATA[DgQWBBT+BEbtoBW+wUtZA/gtDe0q4O35LzCBtgYDVR0jBIGuMIGrgBTmEnw9oQLl 
]]><![CDATA[uh/anje+40U+m67lpqGBj6SBjDCBiTELMAkGA1UEBhMCRkoxDTALBgNVBAgTBEZp 
]]><![CDATA[amkxDTALBgNVBAcTBFN1dmExDjAMBgNVBAoTBVNPUEFDMQwwCgYDVQQLEwNJQ1Qx 
]]><![CDATA[FjAUBgNVBAMTDVNPUEFDIFJvb3QgQ0ExJjAkBgkqhkiG9w0BCQEWF2FkbWluaXN0 
]]><![CDATA[cmF0b3JAc29wYWMub3JnggEAMA0GCSqGSIb3DQEBBAUAA4GBADSN+2ULhVviRAnw 
]]><![CDATA[VTE7KSv0/apf27gRGsarM2dZwQTeNN8IVy7GYNz31OLxc5dXI1ACY/x4ljSzysQb 
]]><![CDATA[xUzIFmm7nEp+ABlIYuJRqzr6/YjN4J3vZ1Da/ksTxQyM/K1ute5A4/00EJ+tNL3b 
]]><![CDATA[Bu0JPfKmgSJjFtyuMwxw/Qpsr7xa
]]><![CDATA[-----END CERTIFICATE-----
]]></programlisting><para>As You may have noticed, the certificate contains the reference to the issuer, the public key of the owner of this certificate, the dates of validity of this certificate and the signature of the certificate to ensure this certificate hasen't been tampered with. The certificate does not contain the private key as it should never be transmitted in any form whatsoever. This certificate has all the elements to send an encrypted message to the owner (using the public key) or to verify a message signed by the author of this certificate.</para></sect2>
<sect2><title>The Symmetric key:</title><para>Well, Private Key/Public Key encryption algorithms are great, but they are not usually practical. It is asymmetric because you need the other key pair to decrypt. You can't use the same key to encrypt and decrypt. An algorithm using the same key to decrypt and encrypt is deemed to have a symmetric key. A symmetric algorithm is much faster in doing its job than an asymmetric algorithm. But a symmetric key is potentially highly insecure. If the enemy gets hold of the key then you have no more secret information. You must therefore transmit the key to the other party without the enemy getting its hands on it. As you know, nothing is secure on the Internet. The solution is to encapsulate the symmetric key inside a message encrypted with an asymmetric algorithm. You have never transmitted your private key to anybody, then the message encrypted with the public key is secure (relatively secure, nothing is certain except death and taxes). The symmetric key is also chosen randomly, so that if the symmetric secret key is discovered then the next transaction will be totally different.</para><programlisting><![CDATA[Symetric Key-->[Public Key]-->Encrypted Symetric Key-->[Private Key]-->Symetric Key
]]></programlisting></sect2>
<sect2><title>Encryption algorithm:</title><para>There are several encryption algorithms available, using symmetric or asymmetric methods, with keys of various lengths. Usually, algorithms cannot be patented, if Henri Poincare had patented his algorithms, then he would have been able to sue Albert Einstein... So algorithms cannot be patented except mainly in USA. OpenSSL is developed in a country where algorithms cannot be patented and where encryption technology is not reserved to state agencies like military and secret services. During the negotiation between browser and web server, the applications will indicate to each other a list of algorithms that can be understood ranked by order of preference. The common preferred algorithm is then chosen. OpenSSL can be compiled with or without certain algorithms, so that it can be used in many countries where restrictions apply. </para></sect2>
<sect2><title>The Hash:</title><para>A hash is a number given by a hash function from a message. This is a one way function, it means that it is impossible to get the original message knowing the hash. However the hash will drastically change even for the slightest modification in the message. It is therefore extremely difficult to modify a message while keeping its original hash. It is also called a message digest. Hash functions are used in password mechanisms, in certifying that applications are original (MD5 sum), and in general in ensuring that any message has not been tampered with. It seems that the Internet Enginering Task Force (IETF) prefers SHA1 over MD5 for a number of technical reasons (Cf RFC2459 7.1.2 and 7.1.3).</para></sect2>
<sect2><title>Signing:</title><para>Signing a message, means authentifying that you have yourself assured the authenticity of the message (most of the time it means you are the author, but not neccesarily). The message can be a text message, or someone else's certificate. To sign a message, you create its hash, and then encrypt the hash with your private key, you then add the encrypted hash and your signed certificate with the message. The recipient will recreate the message hash, decrypts the encrypted hash using your well known public key stored in your signed certificate, check that both hash are equals and finally check the certificate. </para><para>The other advantage of signing your messages is that you transmit your public key and certificate automatically to all your recipients.</para><para>There are usually 2 ways to sign, encapsulating the text message inside the signature (with delimiters), or encoding the message altogether with the signature. This later form is a very simple encryption form as any software can decrypt it if it can read the embedded public key. The advantage of the first form is that the message is human readable allowing any non complaint client to pass the message as is for the user to read, while the second form does not even allow to read part of the message if it has been tampered with.</para></sect2>
<sect2><title>PassPhrase:</title><para>&ldquo;A passprase is like a password except it is longer&rdquo;. In the early days passwords on Unix system were limited to 8 characters, so the term passphrase for longer passwords. Longer is the password harder it is to guess. Nowadays Unix systems use MD5 hashes which have no limitation in length of the password.</para></sect2>
<sect2><title>Public Key Infrastructure</title><para>The Public Key Infrastructure (PKI) is the software management system and database system that allows to sign certifcate, keep a list of revoked certificates, distribute public key,... You can usually access it via a website and/or ldap server. There will be also some people checking that you are who you are... For securing individual applications, you can use any well known commercial PKI as their root CA certificate is most likely to be inside your browser/application. The problem is for securing e-mail, either you get a generic type certificate for your e-mail or you must pay about USD100 a year per certificate/e-mail address. There is also no way to find someone's public key if you have never received a prior e-mail with his certificate (including his public key).</para></sect2>
</sect1>
<sect1><title>What about S/Mime or other protocols?</title><para>If SSL was developed for web servers, it can be used to encrypt any protocol. Any protocol can be encapsulated inside SSL. This is used in IMAPS, POPS, SMTPS,... These secure protocols will use a different port than their insecure version. SSL can also be used to encrypt any transaction: there is no need to be in direct (live) contact with the recipient. S/Mime is such protocol, it encapsulates an encrypted message inside a standard e-mail. The message is encrypted using the public key of the recipient. If you are not online with the recipient then you must know its public key. Either you get it from its web site, from a repository, or you request the recipient to e-mail you its public key and certificate (to ensure you are speaking to the right recipient).</para><para>In a reverse order, the browser can send its own signed certificate to the web server, as a mean of authentication. But everybody can get the browser certificate on the CA web site. Yes, but the signed certificate has been sent encrypted with the private key, that only the public key can decrypt.</para></sect1>
</chapter>
<chapter><title>Certificate Management</title><sect1><title>Installation</title><para>Nowadays, you do not have to worry too much about installing OpenSSL: most distributions use package management applications. Refer to your distribution documentation, or read the README and INSTALL file inside the OpenSSL tarball. I want also to avoid to make this HOWTO, an installation HOWTO rather than an HOWTO use certificates.</para><para>I describe here some standard installation options which are necessary to know for the samples following. Your installation may differ.</para><para>The directory for all OpenSSL certificates is /var/ssl/. All commands and paths in this document are issued from this directory, it is not mandatory but it will help the examples.</para><para>OpenSSL by default looks for a configuration file in /usr/lib/ssl/openssl.cnf so always add -config /etc/openssl.cnf to the commands openssl ca or openssl req for instance. I use /etc/openssl.cnf so all my configuration files are all in /etc.</para><para>Utilities and other libraries are located in /usr/lib/ssl.</para><sect2><title>The CA.pl utility</title><para>Ensure that the utility CA.pl is in an accessible directory such as /usr/sbin. CA.pl can be found inside /usr/lib/ssl directories. CA.pl is a utility that hides the complexity of the openssl command. In all the examples, when I use CA.pl, I will also put the openssl equivalent in brakets.</para><para>/usr/sbin/CA.pl needs to be modified to include -config /etc/openssl.cnf in ca and req calls. </para><programlisting><![CDATA[#$SSLEAY_CONFIG=$ENV{"SSLEAY_CONFIG"}; 
]]><![CDATA[$SSLEAY_CONFIG="-config /etc/openssl.cnf"; 
]]><![CDATA[#$CATOP="./demoCA"; 
]]><![CDATA[$CATOP="/var/ssl";
]]><![CDATA[
]]></programlisting></sect2>
<sect2><title>The openssl.cnf file</title><para>/etc/openssl.cnf must be configured accordingly to minimize input entry.</para><programlisting><![CDATA[
]]><![CDATA[#---Begin---
]]><![CDATA[# 
]]><![CDATA[# OpenSSL example configuration file. 
]]><![CDATA[# This is mostly being used for generation of certificate requests. 
]]><![CDATA[#
]]><![CDATA[
]]><![CDATA[RANDFILE  = $ENV::HOME/.rnd 
]]><![CDATA[oid_file  = $ENV::HOME/.oid 
]]><![CDATA[oid_section  = new_oids
]]><![CDATA[
]]><![CDATA[# To use this configuration file with the "-extfile" option of the 
]]><![CDATA[# "openssl x509" utility, name here the section containing the 
]]><![CDATA[# X.509v3 extensions to use: 
]]><![CDATA[# extensions  = 
]]><![CDATA[# (Alternatively, use a configuration file that has only 
]]><![CDATA[# X.509v3 extensions in its main [= default] section.)
]]><![CDATA[
]]><![CDATA[[ new_oids ]
]]><![CDATA[
]]><![CDATA[# We can add new OIDs in here for use by 'ca' and 'req'. 
]]><![CDATA[# Add a simple OID like this: 
]]><![CDATA[# testoid1=1.2.3.4 
]]><![CDATA[# Or use config file substitution like this: 
]]><![CDATA[# testoid2=${testoid1}.5.6
]]><![CDATA[
]]><![CDATA[#################################################################### 
]]><![CDATA[[ ca ] 
]]><![CDATA[default_ca = CA_default  # The default ca section
]]><![CDATA[
]]><![CDATA[#################################################################### 
]]><![CDATA[
]]><![CDATA[[ CA_default ]
]]><![CDATA[dir             = /var/ssl                # Where everything is kept 
]]><![CDATA[certs           = $dir/certs              # Where the issued certs are kept 
]]><![CDATA[crl_dir         = $dir/crl                # Where the issued crl are kept 
]]><![CDATA[database        = $dir/index.txt          # database index file. 
]]><![CDATA[new_certs_dir   = $dir/newcerts           # default place for new certs.
]]><![CDATA[
]]><![CDATA[certificate     = $dir/cacert.pem         # The CA certificate 
]]><![CDATA[serial          = $dir/serial             # The current serial number 
]]><![CDATA[crl             = $dir/crl.pem            # The current CRL 
]]><![CDATA[private_key     = $dir/private/cakey.pem  # The private key 
]]><![CDATA[RANDFILE        = $dir/private/.rand      # private random number file
]]><![CDATA[x509_extensions = usr_cert                # The extentions to add to the cert
]]><![CDATA[
]]><![CDATA[# Extensions to add to a CRL. Note: Netscape communicator chokes on V2 CRLs 
]]><![CDATA[# so this is commented out by default to leave a V1 CRL.
]]><![CDATA[# crl_extensions = crl_ext
]]><![CDATA[
]]><![CDATA[default_days    = 365                     # how long to certify for 
]]><![CDATA[default_crl_days= 7                       # how long before next CRL 
]]><![CDATA[default_md      = sha1                    # which md to use. 
]]><![CDATA[preserve        = no                      # keep passed DN ordering
]]><![CDATA[
]]><![CDATA[# A few difference way of specifying how similar the request should look 
]]><![CDATA[# For type CA, the listed attributes must be the same, and the optional 
]]><![CDATA[# and supplied fields are just that :-) 
]]><![CDATA[policy  = policy_match
]]><![CDATA[
]]><![CDATA[# For the CA policy 
]]><![CDATA[[ policy_match ] 
]]><![CDATA[countryName            = match 
]]><![CDATA[stateOrProvinceName    = optional 
]]><![CDATA[localityName           = match 
]]><![CDATA[organizationName       = match 
]]><![CDATA[organizationalUnitName = optional 
]]><![CDATA[commonName             = supplied 
]]><![CDATA[emailAddress           = optional
]]><![CDATA[
]]><![CDATA[# For the 'anything' policy 
]]><![CDATA[# At this point in time, you must list all acceptable 'object' 
]]><![CDATA[# types. 
]]><![CDATA[[ policy_anything ] 
]]><![CDATA[countryName            = optional 
]]><![CDATA[stateOrProvinceName    = optional 
]]><![CDATA[localityName           = optional 
]]><![CDATA[organizationName       = optional 
]]><![CDATA[organizationalUnitName = optional 
]]><![CDATA[commonName             = supplied 
]]><![CDATA[emailAddress           = optional
]]><![CDATA[
]]><![CDATA[#################################################################### 
]]><![CDATA[[ req ] 
]]><![CDATA[default_bits       = 1024 
]]><![CDATA[default_keyfile    = privkey.pem 
]]><![CDATA[distinguished_name = req_distinguished_name 
]]><![CDATA[attributes         = req_attributes 
]]><![CDATA[default_md         = sha1
]]><![CDATA[x509_extensions    = v3_ca # The extentions to add to the self signed cert
]]><![CDATA[
]]><![CDATA[# Passwords for private keys if not present they will be prompted for 
]]><![CDATA[# input_password = secret 
]]><![CDATA[# output_password = secret
]]><![CDATA[
]]><![CDATA[# This sets a mask for permitted string types. There are several options. 
]]><![CDATA[# default: PrintableString, T61String, BMPString. 
]]><![CDATA[# pkix : PrintableString, BMPString. 
]]><![CDATA[# utf8only: only UTF8Strings. 
]]><![CDATA[# nombstr : PrintableString, T61String (no BMPStrings or UTF8Strings). 
]]><![CDATA[# MASK:XXXX a literal mask value. 
]]><![CDATA[# WARNING: current versions of Netscape crash on BMPStrings or UTF8Strings 
]]><![CDATA[# so use this option with caution! 
]]><![CDATA[string_mask = nombstr
]]><![CDATA[
]]><![CDATA[# req_extensions = v3_req # The extensions to add to a certificate request
]]><![CDATA[
]]><![CDATA[[ req_distinguished_name ] 
]]><![CDATA[countryName         = Country Name (2 letter code) 
]]><![CDATA[countryName_default = FJ 
]]><![CDATA[countryName_min     = 2 
]]><![CDATA[countryName_max     = 2
]]><![CDATA[ 
]]><![CDATA[stateOrProvinceName         = State or Province Name (full name) 
]]><![CDATA[stateOrProvinceName_default = Fiji
]]><![CDATA[
]]><![CDATA[localityName          = Locality Name (eg, city) 
]]><![CDATA[localityName_default  = Suva
]]><![CDATA[
]]><![CDATA[0.organizationName         = Organization Name (eg, company) 
]]><![CDATA[0.organizationName_default = SOPAC
]]><![CDATA[
]]><![CDATA[# we can do this but it is not needed normally :-) 
]]><![CDATA[#1.organizationName         = Second Organization Name (eg, company) 
]]><![CDATA[#1.organizationName_default = World Wide Web Pty Ltd
]]><![CDATA[
]]><![CDATA[organizationalUnitName         = Organizational Unit Name (eg, section) 
]]><![CDATA[organizationalUnitName_default = ITU
]]><![CDATA[
]]><![CDATA[commonName       = Common Name (eg, YOUR name) 
]]><![CDATA[commonName_max   = 64
]]><![CDATA[emailAddress     = Email Address 
]]><![CDATA[emailAddress_max = 40
]]><![CDATA[
]]><![CDATA[# SET-ex3   = SET extension number 3
]]><![CDATA[
]]><![CDATA[[ req_attributes ] 
]]><![CDATA[challengePassword     = A challenge password 
]]><![CDATA[challengePassword_min = 4 
]]><![CDATA[challengePassword_max = 20
]]><![CDATA[
]]><![CDATA[unstructuredName      = An optional company name
]]><![CDATA[
]]><![CDATA[[ usr_cert ]
]]><![CDATA[
]]><![CDATA[# These extensions are added when 'ca' signs a request.
]]><![CDATA[# This goes against PKIX guidelines but some CAs do it and some software 
]]><![CDATA[# requires this to avoid interpreting an end user certificate as a CA.
]]><![CDATA[
]]><![CDATA[basicConstraints=CA:FALSE
]]><![CDATA[
]]><![CDATA[# Here are some examples of the usage of nsCertType. If it is omitted 
]]><![CDATA[# the certificate can be used for anything *except* object signing.
]]><![CDATA[
]]><![CDATA[# This is OK for an SSL server. 
]]><![CDATA[# nsCertType   = server
]]><![CDATA[
]]><![CDATA[# For an object signing certificate this would be used. 
]]><![CDATA[# nsCertType = objsign
]]><![CDATA[
]]><![CDATA[# For normal client use this is typical 
]]><![CDATA[# nsCertType = client, email
]]><![CDATA[
]]><![CDATA[# and for everything including object signing: 
]]><![CDATA[# nsCertType = client, email, objsign
]]><![CDATA[
]]><![CDATA[# This is typical in keyUsage for a client certificate. 
]]><![CDATA[# keyUsage = nonRepudiation, digitalSignature, keyEncipherment
]]><![CDATA[
]]><![CDATA[# This will be displayed in Netscape's comment listbox. 
]]><![CDATA[nsComment  = "Certificate issued by https://www.sopac.org/ssl/"
]]><![CDATA[
]]><![CDATA[# PKIX recommendations harmless if included in all certificates. 
]]><![CDATA[subjectKeyIdentifier=hash 
]]><![CDATA[
]]><![CDATA[authorityKeyIdentifier=keyid,issuer:always
]]><![CDATA[
]]><![CDATA[# This stuff is for subjectAltName and issuerAltname. 
]]><![CDATA[# Import the email address. 
]]><![CDATA[# subjectAltName=email:copy
]]><![CDATA[
]]><![CDATA[# Copy subject details 
]]><![CDATA[# issuerAltName=issuer:copy
]]><![CDATA[
]]><![CDATA[# This is the base URL for all others URL addresses 
]]><![CDATA[# if not supplied
]]><![CDATA[nsBaseUrl  = https://www.sopac.org/ssl/
]]><![CDATA[
]]><![CDATA[# This is the link where to download the latest Certificate
]]><![CDATA[# Revocation List (CRL)
]]><![CDATA[nsCaRevocationUrl = https://www.sopac.org/ssl/sopac-ca.crl
]]><![CDATA[
]]><![CDATA[# This is the link where to revoke the certificate
]]><![CDATA[nsRevocationUrl  = https://www.sopac.org/ssl/revocation.html? 
]]><![CDATA[
]]><![CDATA[# This is the location where the certificate can be renewed
]]><![CDATA[nsRenewalUrl  = https://www.sopac.org/ssl/renewal.html? 
]]><![CDATA[
]]><![CDATA[# This is the link where the CA policy can be found
]]><![CDATA[nsCaPolicyUrl  = https://www.sopac.org/ssl/policy.html 
]]><![CDATA[
]]><![CDATA[# This is the link where we can get the issuer certificate
]]><![CDATA[issuerAltName = URI:https://www.sopac.org/ssl/sopac.crt
]]><![CDATA[
]]><![CDATA[# This is the link where to get the latest CRL
]]><![CDATA[crlDistributionPoints = URI:https://www.sopac.org/ssl/sopac-ca.crl
]]><![CDATA[
]]><![CDATA[[ v3_ca ]
]]><![CDATA[
]]><![CDATA[# Extensions for a typical CA
]]><![CDATA[
]]><![CDATA[# PKIX recommendation.
]]><![CDATA[ 
]]><![CDATA[subjectKeyIdentifier=hash
]]><![CDATA[
]]><![CDATA[authorityKeyIdentifier=keyid:always,issuer:always
]]><![CDATA[
]]><![CDATA[# This is what PKIX recommends but some broken software chokes on critical 
]]><![CDATA[# extensions. 
]]><![CDATA[# basicConstraints = critical,CA:true 
]]><![CDATA[# So we do this instead. 
]]><![CDATA[basicConstraints = CA:true
]]><![CDATA[
]]><![CDATA[# Key usage: this is typical for a CA certificate. However since it will 
]]><![CDATA[# prevent it being used as an test self-signed certificate it is best 
]]><![CDATA[# left out by default. 
]]><![CDATA[# keyUsage = cRLSign, keyCertSign
]]><![CDATA[
]]><![CDATA[# Some might want this also 
]]><![CDATA[# nsCertType = sslCA, emailCA
]]><![CDATA[
]]><![CDATA[# Include email address in subject alt name: another PKIX recommendation 
]]><![CDATA[# subjectAltName=email:copy 
]]><![CDATA[# Copy issuer details 
]]><![CDATA[# issuerAltName=issuer:copy
]]><![CDATA[
]]><![CDATA[# RAW DER hex encoding of an extension: beware experts only! 
]]><![CDATA[# 1.2.3.5=RAW:02:03 
]]><![CDATA[# You can even override a supported extension: 
]]><![CDATA[# basicConstraints= critical, RAW:30:03:01:01:FF
]]><![CDATA[
]]><![CDATA[# This will be displayed in Netscape's comment listbox. 
]]><![CDATA[nsComment  = "Certificate issued by https://www.sopac.org/ssl/"
]]><![CDATA[
]]><![CDATA[# This is the base URL for all others URL addresses 
]]><![CDATA[# if not supplied
]]><![CDATA[nsBaseUrl  = https://www.sopac.org/ssl/
]]><![CDATA[
]]><![CDATA[# This is the link where to download the latest Certificate
]]><![CDATA[# Revocation List (CRL)
]]><![CDATA[nsCaRevocationUrl = https://www.sopac.org/ssl/sopac-ca.crl
]]><![CDATA[
]]><![CDATA[# This is the link where to revoke the certificate
]]><![CDATA[nsRevocationUrl  = https://www.sopac.org/ssl/revocation.html? 
]]><![CDATA[
]]><![CDATA[# This is the location where the certificate can be renewed
]]><![CDATA[nsRenewalUrl  = https://www.sopac.org/ssl/renewal.html? 
]]><![CDATA[
]]><![CDATA[# This is the link where the CA policy can be found
]]><![CDATA[nsCaPolicyUrl  = https://www.sopac.org/ssl/policy.html 
]]><![CDATA[
]]><![CDATA[# This is the link where we can get the issuer certificate
]]><![CDATA[issuerAltName = URI:https://www.sopac.org/ssl/sopac.crt
]]><![CDATA[
]]><![CDATA[# This is the link where to get the latest CRL
]]><![CDATA[crlDistributionPoints = URI:https://www.sopac.org/ssl/sopac-ca.crl
]]><![CDATA[
]]><![CDATA[[ crl_ext ]
]]><![CDATA[# CRL extensions. 
]]><![CDATA[# Only issuerAltName and authorityKeyIdentifier make any sense in a CRL.
]]><![CDATA[# issuerAltName=issuer:copy 
]]><![CDATA[authorityKeyIdentifier=keyid:always,issuer:always
]]><![CDATA[
]]><![CDATA[
]]><![CDATA[#----End----
]]></programlisting><para>A few comments on openssl.cnf. </para><itemizedlist><listitem><para>Variable names can use the suffixes _default for default value, _min for the minimum number of characters required and _max for the maximum number of characters required.</para></listitem><listitem><para>The file is composed of &lsqb;Sections&rsqb; of variables.</para></listitem></itemizedlist><variablelist><varlistentry><term>dir:
</term><listitem><para>Specifies the base directory.</para></listitem></varlistentry><varlistentry><term>default_ca:
</term><listitem><para>Specifies which section contains the variables for a default certificate.</para></listitem></varlistentry><varlistentry><term>basicConstraints:
</term><listitem><para>Defines the usage of the certificate, for instance with CA:TRUE, the certificate is a root CA Certificate.</para></listitem></varlistentry></variablelist></sect2>
<sect2><title>Create the Certification Authority</title><para>To create a certification authority, use the command after correctly editing openssl.cnf:</para><programlisting><![CDATA[CA.pl -newca
]]></programlisting><para>The utility will ask you to select a certificate file to act as you CA certificate or you are prompted to create one. Follow the steps to create one as exrecise. In the next chapter we will overwrite this default created CA to create a new one with a longer life span. CA.pl creates only 365 days certificates.</para></sect2>
</sect1>
<sect1><title>Create a Root Certification Authority Certificate.</title><programlisting><![CDATA[CA.pl -newcert 
]]><![CDATA[(openssl req -config /etc/openssl.cnf -new -x509 -keyout newreq.pem \
]]><![CDATA[-out newreq.pem -days 365) 
]]></programlisting><para>creates a self signed certificate (for Certificate Authority). The resulting file goes into newreq.pem. For the common Name (CN) use something like &ldquo;ACME root Certificate&rdquo;. This file needs to be split into 2 files cacert.pem and private/cakey.pem. The part -RSA PRIVATE KEY- goes into private/cakey.pem while the part -CERTIFICATE- goes into cacert.pem. Delete newreq.pem when finished.</para><para>Now ensure that the file index.txt is empty and that the file serial contains 01.</para><para>You may want to increase the number of days so that your root certificate and all the certificates signed by this root does not have to be changed when the root certificate expires. I think professional companies work over 5 years to 10 years for their root certificates.</para><programlisting><![CDATA[openssl req -config /etc/openssl.cnf -new -x509 -keyout private/cakey.pem \
]]><![CDATA[-out cacert.pem -days 3650
]]></programlisting><para>This last command is better than &ldquo;CA.pl -newcert&rdquo; as it will place the files in the required locations and create a root CA valid for 10 years.</para><para>Now ensure that this self signed root certificate is used only to sign other certificates. The private key is highly sensible, never compromise it, by removing the passphrase that protects it. Some people will place the private key on a floppy and will load it only when signing other certificates. If you computer gets hacked they can't physically get hold of the private key, if it is on a floppy.</para><para>Now you have a root Certification Authority. Other people need to trust your self-signed root CA Certificate, and therefore download it and register it on their browser.</para><para>You will have to type the passphrase each time you want to sign another certificate with it.</para></sect1>
<sect1><title>Create a non root Certification Authority Certificate.</title><para>FIXME because I'm not sure about the procedure.</para><para>It is possible to use any signed certificate to sign any other certificate, provided that the certificate is valid and has been issued with the signing capability. So you can create a certificate request and a private key, make the certificate been signed by a third party and install the signed certificate and private key. The part -PRIVATE KEY- goes into private/cakey.pem while the part -CERTIFICATE- goes into cacert.pem. </para></sect1>
<sect1><title>Install the CA root certificate as a Trusted Root Certificate </title><para>First strip the certificate from all its text to keep only the -CERTIFICATE- section</para><programlisting><![CDATA[openssl x509 -in cacert.pem -out cacert.crt
]]></programlisting><para>Place this file on your web site as http://mysite.com/ssl/cacert.crt. Your web server should have a mime entry for .crt files. Your certificate is ready to be downloaded by any browser and saved.</para><para>It is important to publish the root CA Certificate on a web site as it is unlikely that people will have it already loaded on their browser. Beware, somebody could fake your web site and fake your root CA Certificate. If you can have more than one way for users to get your certificate, it is unlikely that a hacker will be able to corrupt everything.</para><para>Microsoft proposes a windows update feature that will push approved root certificate to internet explorers out there. You can contact Microsoft to have your root certificate added in their database and maybe in their future releases.</para><sect2><title>In Netscape/Mozilla</title><para>Download the certificate from the web server or from the file system using Netscape. Netscape automatically recognises that it is a root certificate and will propose you to add it in its store. Follow the wizard to install the certifcate. At the end of the wizard you have to specify for which type of application you trust this certifcate: web site security, e-mail signing, or code signing.</para></sect2>
<sect2><title>In Galeon</title><para>Galeon works like Mozilla as it uses the same HTML rendering engine. However there is no Certificate management tool included in Galeon.</para></sect2>
<sect2><title>In Opera</title><para>FIXME</para></sect2>
<sect2><title>In Internet Explorer </title><para>With your browser, point to the address of the certificate and save the file on your disk. Double click on the file and the Certificate Installation wizard will start. Because the certificate is self signed, Internet explorer will automatically install it in the Trusted root Certificate Authority list. From now on, Internet Explorer won't complain and any Certificate signed with this root CA Certificate will be trusted too.</para><para>You can also open it from Internet explorer which will display the certificate. Click on the button Install Certificate to launch the Certificate Installation wizard.</para></sect2>
</sect1>
<sect1><title>Certificate management</title><sect2><title>Generate and Sign a certificate request </title><programlisting><![CDATA[CA.pl -newreq 
]]><![CDATA[(openssl req -config /etc/openssl.cnf -new -keyout newreq.pem -out newreq.pem \
]]><![CDATA[-days 365) 
]]></programlisting><para>creates a new private key and a certificate request and place it as newreq.pem. Enter a Common Name (CN) the main usage of the certificate for instance www.sopac.org if you want to secure the website www.sopac.org, or enter franck@sopac.org if you want to use to secure the e-mails of franck@sopac.org.</para><programlisting><![CDATA[CA.pl -sign 
]]><![CDATA[(openssl ca -config /etc/openssl.cnf -policy policy_anything -out newcert.pem \
]]><![CDATA[-infiles newreq.pem) 
]]></programlisting><para>will sign the request using the cacert.pem and commit the certificate as newcert.pem. You will need to enter the passphrase of the cacert.pem (your CA Certificate). The file newcerts/xx.pem will be created and index.txt and serial will be updated.</para><para>You private key is in newreq.pem -PRIVATE KEY- and your certificate is in newcert.pem -CERTIFICATE-</para><para>A copy of newcert.pem is placed in newcerts/ with an adequate entry in index.txt so that a client can request this information via a web server to ensure the authenticity of the certificate.</para><para>Beware of your newreq.pem file, because it contains a certificate request, but also your private key. The -PRIVATE KEY- section is not required when you sign it. So if you request someone else to sign your certificate request, ensure that you have removed the -PRIVATE KEY- section from the file. If you sign someone else certificate request, request from this person its -CERTIFICATE REQUEST- section not its private key.</para></sect2>
<sect2><title>Revoke a certificate</title><para>To revoke a certificate simply issue the command:</para><programlisting><![CDATA[openssl -revoke newcert.pem
]]></programlisting><para>The database is updated and the certificate is marked as revoked. You now need to generate the new revoked list of certificates:</para><programlisting><![CDATA[openssl ca -gencrl -config /etc/openssl.cnf -out crl/sopac-ca.crl
]]></programlisting><para>This Certificate Revokation List (CRL) file should be made available on your web site.</para><para>You may want to add the parameters crldays or crlhours and crlexts when you revoke a certificate. The first two parameters indicate when the next CRL will be updated and the last one will use the crl_exts section in openssl.cnf to produce a CRL v2 instead of a CRL v1.</para><programlisting><![CDATA[openssl ca -gencrl -config /etc/openssl.cnf -crldays 7 -crlexts crl_ext \
]]><![CDATA[-out crl/sopac-ca.crl
]]></programlisting></sect2>
<sect2><title>Renew a certificate</title><para>The user sends you its old certificate request or create a new one based on its private key.</para><para>First you have to revoke the previous certificate and sign again the certificate request. </para><para>To find the old certificate, look in the index.txt file for the Distinguished Name (DN) corresponding to the request. Get the serial Number &lt;xx&gt;, and use the file cert/&lt;xx&gt;.pem as certificate for the revocation procedure.</para><para>You may want to sign the request manually because you have to ensure that the start date and end date of validity of the new certificate are correct.</para><programlisting><![CDATA[openssl ca -config /etc/openssl.cnf -policy policy_anything -out newcert.pem \
]]><![CDATA[-infiles newreq.pem -startdate [now] -enddate [previous enddate+365days]
]]></programlisting><para>replace &lsqb;now&rsqb; and &lsqb;previous enddate+365days&rsqb; by the correct values.</para></sect2>
<sect2><title>Display a certificate</title><para>You may have a certificate in its coded form, to read the details of the certificate just issue the following command:</para><programlisting><![CDATA[openssl x509 -in newcert.pem -noout -text
]]></programlisting></sect2>
<sect2><title>The index.txt file</title><para>In the index.txt file you can find the various certificate managed by OpenSSL. The entries are maked with R for Revoked, V for Valid and E for expired.</para></sect2>
<sect2><title>Build your web based Certificate Authority</title><para>There are a few requirements when you are a Certificate Authority (CA):</para><orderedlist><listitem><para>You must publish your root CA Certificate, so that it can be widely installed in applications.</para></listitem><listitem><para>You must publish the revocation list.</para></listitem><listitem><para>You must display a certificate detail, provided its serial number</para></listitem><listitem><para>You must provide a form for users to submit certificate requests.</para></listitem></orderedlist><para>All these requirements can be done using a web server and some scripting.</para><para>FIXME: some code here for the web interface...</para></sect2>
</sect1>
</chapter>
<chapter><title>Using Certificates in Applications</title><sect1><title>Securing Internet Protocols.</title><sect2><title>Using a certificate with mod_ssl in apache</title><para>First never use your self-signed root CA Certificate with any application and especially with apache as it requires you to remove the passphrase on your private key.</para><para>First generate and sign a certificate request with the Common Name (CN) as www.mysite.com. Remove any extra information to keep only the ---CERTIFCATE --- part.</para><para>The key needs to be made insecure, so no password is required when reading the private key. Take the newreq.pem files that contains your private key and remove the passphrase from it. </para><programlisting><![CDATA[openssl rsa -in newreq.pem -out wwwkeyunsecure.pem
]]></programlisting><para>Because the key (PRIVATE Key) is insecure, you must know what you are doing: check file permissions, etc... If someone gets its hand on it, your site is compromised (you have been warned). Now you can use the newcert and cakeyunsecure.pem for apache.</para><para>Copy wwwkeyunsecure.pem and newcert.pem in the directory /etc/httpd/conf/ssl/ as wwwkeyunsecure.pem and wwwcert.crt respectively.</para><para>Edit /etc/httpd/conf/ssl/ssl.default-vhost.conf.</para><programlisting><![CDATA[---- 
]]><![CDATA[# Server Certificate: 
]]><![CDATA[# Point SSLCertificateFile at a PEM encoded certificate. If 
]]><![CDATA[# the certificate is encrypted, then you will be prompted for a 
]]><![CDATA[# pass phrase. Note that a kill -HUP will prompt again. A test 
]]><![CDATA[# certificate can be generated with `make certificate' under 
]]><![CDATA[# built time. 
]]><![CDATA[#SSLCertificateFile conf/ssl/ca.crt 
]]><![CDATA[SSLCertificateFile wwwcert.crt
]]><![CDATA[# Server Private Key: 
]]><![CDATA[# If the key is not combined with the certificate, use this 
]]><![CDATA[# directive to point at the key file. 
]]><![CDATA[#SSLCertificateKeyFile conf/ssl/ca.key.unsecure 
]]><![CDATA[SSLCertificateKeyFile wwwkeyunsecure.pem 
]]><![CDATA[----
]]></programlisting><para>Stop and start httpd (/etc/rc.d/init.d/httpd stop) ensure that all processes are dead (killall httpd) and start httpd (/etc/rc.d/init.d/httpd start)</para></sect2>
<sect2><title>Using a certificate with IMAPS</title><para>Read the paragraph on &ldquo;Using a certificate with POPS&rdquo;, for more information.</para></sect2>
<sect2><title>Using a certificate with POPS</title><para>A pem file for ipop3sd can be created by generating a certificate, unsecuring the private key and combining the two into /etc/ssl/imap/ipop3sd.pem. This is the location where the imap rpm on Mandrake 9.0 expects to find the file. A similar procedure can be used for imap and putting the file in /etc/ssl/imap/imapsd.pem.</para><para>The CN should be the name that the mail client connects to (e.g mail.xyz.org). In MS-Outlook, on the server tab, enter for the incoming mail server mail.xyz.org and on the Advanced tab check the &ldquo;This server requires a secure connection (SSL)&rdquo;, this will change the connection port to 995 (imaps). The trusted root CA must be installed in MS Internet Explorer to validate the certificate from mail.xyz.org.</para></sect2>
<sect2><title>Using a certificate with Postfix</title><para>FIXME</para></sect2>
<sect2><title>Using a certificate with Stunnel</title><para>FIXME</para></sect2>
<sect2><title>Generate and Sign a key with Microsoft Key Manager </title><para>In Microsoft Key Manager, select the service you want to create a key for, for instance IMAP (or WWW). Use the wizard to generate a new key. Ensure that the distinguished name won't be identical to previous generated keys, for Instance for the Common Name (CN) use imap.mycompany.com. The wizard will place the request in the file C:&bsol;NewKeyRq.txt. Key Manager shows a Key with a strike to indicate the key is not signed.</para><para>Import this file in the OpenSSL /var/ssl directory, rename it to newreq.pem and sign the request as usual. </para><programlisting><![CDATA[CA.pl -sign
]]></programlisting><para>The file newcert.pem is not yet suitable for key manager as it contains some text and the -CERTIFICATE- section. We have to remove the text, the easy way is to do: </para><programlisting><![CDATA[openssl x509 -in newcert.pem -out newcertx509.pem
]]></programlisting><para>Using a text editor is also suitable to delete everything outside the -CERTIFICATE- section.</para><para>The newcertx509.pem file now contains only the -CERTIFICATE- section.</para><para>Export the file newcertx509.pem to the Computer running key Manager and while selecting the key icon in the Key Manager application, right click and click on Install the Key Certificate, select this file, enter the passphrase. The key is now fully functional.</para></sect2>
</sect1>
<sect1><title>Securing E-mails.</title><sect2><title>Generate and use an s/mime certificate </title><para>Simply generate and sign a certificate request but with the Common Name (CN) being your e-mail address.</para><para>Now sign your message test.txt (output test.msg) using your certificate newcert.pem and your key newreq.pem: </para><programlisting><![CDATA[openssl smime -sign -in test.txt -text -out test.msg -signer newcert.pem -inkey newreq.pem
]]></programlisting><para>You can now transmit test.msg to anybody, you can use this procedure to make signed advisories, or other signed documents to be published digitally.</para></sect2>
<sect2><title>To use this certificate with MS Outlook </title><para>You need to import it in Outlook as a pkcs12 file. To generate the pkcs12 file from your newcert.pem and newreq.pem:</para><programlisting><![CDATA[CA.pl -pkcs12 "Franck Martin"
]]><![CDATA[(openssl pkcs12 -export -in newcert.pem -inkey newreq.pem -out newcert.p12 \
]]><![CDATA[-name "Franck Martin")
]]></programlisting><para>or use this command to bundle the signing certificate with your pkcs12 file</para><programlisting><![CDATA[openssl pkcs12 -export -in newcert.pem -inkey newreq.pem -certfile cacert.pem \
]]><![CDATA[-out newcert.p12 -name "Franck Martin"
]]></programlisting><para>Beware this certificate contains your public and private key and is only secured by the passphrase. This is a file not to let into everybody's hand.</para><para>In MS Outlook go to Tools, Options and Security, Click on the import/export button select to import the newcert.p12 file, enter the export password and the Digital ID &quot;Franck Martin&quot; (That's my name so use your name in the above examples). And Click on Ok.</para><para>Now click on the Settings button, MS Outlook should have selected the default setting so just click on New. And finally click on Ok, except if you want to change the default settings. You are ready to send signed e-mails. When you send a signed e-mail the user at the other end will receive your public key, and will therefore be able to send you encrypted e-mails.</para><para>As you have issued this certificate from a self-signed certificate (root CA Certificate), the trust path won't be valid because the application does not know the root CA Certificate. The root CA certificate has to be downloaded and installed. Refer to the chapter &quot;Install the CA root certificate as a Trusted Root Certificate in Internet Explorer&quot;.</para><para>You can send your message as encrypted signed messages or clear text message. The encryption is not really an encryption as the message contains everything needed to decrypt the message, but it ensures that the recipient won't read the message if he does not have an s/mime compliant reader.</para><para>Note that early version of MS-Outlook XP will search the Internet to verify the validy of the certificate. It can take several seconds before the e-mail is displayed and several minutes for MS-Outlook XP to timeout when you don't have a full time or on-demand Internet connection. The bug is that this process is exclusive, the whole machine freezes till MS-Outlook XP has finished somehow.</para></sect2>
<sect2><title>To use this certificate with MS Outlook Express</title><para>FIXME</para></sect2>
<sect2><title>To use this certificate with Netscape Messenger</title><para>FIXME</para></sect2>
<sect2><title>To use this certificate with Evolution</title><para>Evolution 1.0 does not work with S/MIME, but only with PGP. It is planned that Evolution will handle S/MIME in a future release (from the evolution bug database). However in some instances Evolution recognises that the document is clear text signed and displays it correctly, even though it can't check the signature (early versions of Evolution does not understand one of the 3 MIME signature types, unfortunately the one MS-Outlook uses quite often).</para></sect2>
<sect2><title>To use this certificate with Balsa</title><para>FIXME</para></sect2>
<sect2><title>To use this certifcate with KMail</title><para>FIXME</para></sect2>
</sect1>
<sect1><title>Securing Files</title><sect2><title>WinCrypt</title><para><ulink url="http://www.wincrypt.de/">WinCrypt</ulink> uses the Microsoft crypto API to encrypt and /or sign files. It will optionnaly create a zip archive of the selected files/folders before signing. It provides a front end to the certificate store, allowing the user to browse the installed certificate store, install and delete certificates and choose the certificate to use for WinCrypt signing.</para><para>The procedure for creating a certificate is the same as for Microsoft Outlook. Indeed it uses the same certificate store, you can point WinCrypt to a certificate previously installed for Outlook and vice-versa.</para><para>It is possible to verify a WinCrypt signed file filename.sgn using:</para><programlisting><![CDATA[openssl smime -verify -inform der -in filename.sgn -CAfile cacert.crt
]]></programlisting><para>To sign a file with openSSL in a compatible format use:</para><programlisting><![CDATA[openssl smime -sign -outform der -nodetach -out filename.sgn \
]]><![CDATA[-signer certificate.pem -in filename.txt
]]></programlisting><para>To view the structure of a signed file:</para><programlisting><![CDATA[openssl asn1parse -inform der -in filename.sgn
]]></programlisting></sect2>
</sect1>
<sect1><title>Securing Code</title><sect2><title>Micosoft Code</title><para>You can sign your programs and applet to certify that you are the author of such code. It is important for your customes to trust that nobody has tried to insert a virus or a backdoor inside your code. To authenticate your code you need Microsoft Authenticode SDK. You can get it from the Microsoft web site in the MSDN section.</para><para>Gernerate a certificate as usual but with a Common Name (CN) like &ldquo;ACME Software Cert&rdquo;. Have the certificate signed by the CA and convert it to a pkcs12 format.</para><programlisting><![CDATA[CA.pl -newreq
]]><![CDATA[CA.pl -sign
]]><![CDATA[CA.pl -pkcs12 "ACME Software Cert"
]]></programlisting><para>You get a file called newcert.p12 that you import in the Certificate store by clicking on the file when in Windows.</para><para>You can now use this certificate for signing your code</para><programlisting><![CDATA[signcode -cn "ACME Software cert" -tr 5 -tw 2 -n "My Application" \
]]><![CDATA[-i http://www.acme.com/myapp/ \
]]><![CDATA[-t http://timestamp.verisign.com/scripts/timstamp.dll myapp.exe
]]></programlisting><para>When you try to install and run your application a dialog will appears with the title &ldquo;My Application&rdquo; and with a link pointed by the -i argument.</para></sect2>
</sect1>
<sect1><title>IPSec</title><para>IPSec is a new protocol that sits on top of IP that provides ad-hoc encrypted links between 2 hosts on the Internet. The IPSec implementation is mandatory for IPv6 and can be added to IPv4. If IPSec is part of IPv6, it does not mean that it is deployed by network managers. IPSec is not simple to implement due to the difficulty of having mechanisms to exchange keys automatically between machines. DNS can help, but it is not mainstream, and well known Certificate Authorities do not yet deliver adequate certification facilities for a wide deployement in the enterprise.</para><sect2><title>FreeS/WAN</title><para><ulink url="http://www.freswan.org/">FreeS/WAN</ulink> is a popular implementation of IPSec for GNU/Linux. At its current version (1.9.7) it needs to be patched to incorporate X.509 capability. You can find a patched version on <ulink url="http://www.freeswan.ca/">this site</ulink>. Some GNU/Linux distrubutions have applied the patch for you so check your package. The advantage of this version is that you can use openssl to create certificates to use with FreeS/WAN and DNS CERT records, but more specifically you can interact with the Microsoft Implementation of IPSec. For more information check <ulink url="http://www.natecarlson.com/linux/ipsec-x509.php">Nate's page</ulink>.</para><sect3><title>FreeS/WAN gateway machine</title><para>Generate a certificate with the CN beeing the fully qualified domain name of your IPSec gateway: host.example.com. Do not forget to sign the certificate. You have two files newcert.pem and newreq.pem. The file newreq.pem contains the private key and some extra information therefore needs to be edited to contain only the private key. Delete everything outside the --BEGIN RSA PRIVATE KEY-- and --END RSA PRIVATE KEY--. Move the files to the appropriate locations on your gateway machine. Make sure that you do that securely. On my distribution all configuration files for FreeS/WAN are located in /etc/freeswan, it could be different in yours.</para><programlisting><![CDATA[mv newreq.pem /etc/freeswan/ipsec.d/private/host.example.com.key
]]><![CDATA[mv newcert.pem /etc/freeswan/ipsec.d/host.example.com.pem
]]></programlisting><para>Copy also your root certificate to the FreeS/WAN configuration directory. Copy only the certificate, not the key.</para><programlisting><![CDATA[mv cacert.pem /etc/freeswan/ipsec.d/cacerts
]]></programlisting><para>Generate a certificate revocation list or copy yours to the right location.</para><programlisting><![CDATA[openssl ca -genrcl -out /etc/freeswan/ipsec.d/crls/crl.pem
]]></programlisting><para>Still on the gateway machine, configure the ipsec.secrets file by including the line:</para><programlisting><![CDATA[: RSA host.example.com.key ]]>&ldquo;<![CDATA[password]]>&rdquo;<![CDATA[
]]></programlisting><para>The password being the one used to generate the key pair. Configure ipsec.conf as following:</para><programlisting><![CDATA[config setup
]]><![CDATA[interfaces=%defaultroute
]]><![CDATA[klipsdebug=none
]]><![CDATA[plutodebug=none
]]><![CDATA[plutoload=%search
]]><![CDATA[plutostart=%search
]]><![CDATA[uniqueids=yes
]]><![CDATA[
]]><![CDATA[conn %default
]]><![CDATA[keyingtries=1
]]><![CDATA[compress=yes
]]><![CDATA[disablearrivalcheck=no
]]><![CDATA[authby=rsasig
]]><![CDATA[leftrsasigkey=%cert
]]><![CDATA[rightrsasigkey=%cert
]]><![CDATA[
]]><![CDATA[conn roadwarrior-net
]]><![CDATA[leftsubnet=<your_subnet>/<your_netmask>
]]><![CDATA[also=roadwarrior
]]><![CDATA[
]]><![CDATA[conn roadwarrior
]]><![CDATA[right=%any
]]><![CDATA[left%defaultroute
]]><![CDATA[leftcert=host.example.com.pem
]]><![CDATA[auto=add
]]><![CDATA[pfs=yes
]]></programlisting><para>As you can see there are 2 connections beeing established, one to the gateway machine and one to the network behind the gateway machine. This is particulary useful if you are operating some kind of firewall/NAT on your gateway machine. The configuration is such that anybody with a valid certificate will be able to connect to the gateway machine.</para></sect3>
<sect3><title>FreeS/WAN client machine</title><para>The procedure is similar, you need to generate a certificate for the client machine with the CN being the fully qualified domain name of the client machine, for instance clienthost.example.com. This certificate must be signed by the same signing authorithy as the gateway certificate. This is how the link will be authorised.</para><para>As with the gateway copy the following files securely to the configuration directories:</para><programlisting><![CDATA[mv newreq.pem /etc/freeswan/ipsec.d/private/clienthost.example.com.key
]]><![CDATA[mv newcert.pem /etc/freeswan/ipsec.d/clienthost.example.com.pem
]]></programlisting><para>Copy also your root certificate to the FreeS/WAN configuration directory. Copy only the certificate, not the key.</para><programlisting><![CDATA[mv cacert.pem /etc/freeswan/ipsec.d/cacerts
]]></programlisting><para>Generate a certificate revocation list or copy yours to the right location.</para><programlisting><![CDATA[openssl ca -genrcl -out /etc/freeswan/ipsec.d/crls/crl.pem
]]></programlisting><para>Finally you need to copy also the certificate (not the private key) of your gateway machine</para><programlisting><![CDATA[mv host.example.com.pem /etc/fresswan/ipsec.d/host.example.com.pem
]]></programlisting><para>Similarly edit your ipsec.secrets file to load the client private key</para><programlisting><![CDATA[: RSA clienthost.example.com.key ]]>&ldquo;<![CDATA[password]]>&rdquo;<![CDATA[
]]></programlisting><para>and edit the ipsec.conf as follows to enable the connection:</para><programlisting><![CDATA[config setup
]]><![CDATA[interfaces=%defaultroute
]]><![CDATA[klipsdebug=none
]]><![CDATA[plutodebug=none
]]><![CDATA[plutoload=%search
]]><![CDATA[plutostart=%search
]]><![CDATA[uniqueids=yes
]]><![CDATA[
]]><![CDATA[conn %default
]]><![CDATA[keyingtries=0
]]><![CDATA[compress=yes
]]><![CDATA[disablearrivalcheck=no
]]><![CDATA[authby=rsasig
]]><![CDATA[leftrsasigkey=%cert
]]><![CDATA[rightrsasigkey=%cert
]]><![CDATA[
]]><![CDATA[conn roadwarrior-net
]]><![CDATA[left=(ip of host)
]]><![CDATA[leftsubnet=(gateway_host_subnet)/(gateway_host_netmask)
]]><![CDATA[also=roadwarrior
]]><![CDATA[
]]><![CDATA[conn roadwarrior
]]><![CDATA[left=(ip of host)
]]><![CDATA[leftcert=host.example.com.pem
]]><![CDATA[right=%defaultroute
]]><![CDATA[rightcert=clienthost.example.com.pem
]]><![CDATA[auto=add
]]><![CDATA[pfs=yes
]]></programlisting><para>Now you can start the VPN link</para><programlisting><![CDATA[ipsec auto --up roadwarrior
]]><![CDATA[ipsec auto --up roadwarrior-net
]]></programlisting><para>To start the link automatically, replace in the configuration file 'auto=add' by 'auto=start'</para></sect3>
<sect3><title>MS Windows 2000/XP client machine</title><para>The procedure is the same as for the FreeS/WAN client. Generate a certificate with a CN of winhost.example.com, but you will have to convert this certificate into a .p12 file. Follow the procedure in the chapter &ldquo;Using this certificate with MS-Outlook&rdquo; but ensure that the .p12 file is bundled with the root CA certificate: winhost.example.com.p12</para><para>Additionally note the output of:</para><programlisting><![CDATA[openssl x509 -in cacert.pem -noout -subject
]]></programlisting><para>Copy this file securely to the MS-Windows machine.</para><para>You know need to install Marcus Muller's <ulink url="http://vpn.ebotis.de/">ipsec.exe utility</ulink> in for instance c:&bsol;ipsec directory.</para><para>Open Microsoft Management Console (MMC), in 'Add/Remove Snap-in' click on 'Add' then click on 'Certificates', then 'Add' Select 'Computer Account', and 'Next'. Select 'Local computer', and 'Finish'. Click on 'IP Security Policy Management', and 'Add'. Select 'Local Computer', and 'Finish' click 'Close' then 'OK'</para><para>Now you can add the .p12 certificate</para><para>Click the plus arrow by 'Certificates (Local Computer)' then right-click 'Personal', and click 'All Tasks' then 'Import' click 'Next'. Type the path to the .p12 file (or browse and select the file), and click 'Next'. Type the export password, and click 'Next'. Select 'Automatically select the certificate store based on the type of certificate', and click 'Next'. Click 'Finish', and say yes to any prompts that pop up. Exit the MMC, and save it as a file so you don't have to re-add the Snap In each time.</para><para>Install ipsecpol.exe (Windows 2000) or ipseccmd.exe (Windows XP) as described in the documentation for the ipsec utility. Edit your ipsec.conf (on the windows machine), replacing the &quot;RightCA&quot; with the output of the 'openssl x509 -in cacert.pem -noout -subject'; reformatted as below (you need to change the /'s to commas, and change the name of some of the fields -- just follow the example below):</para><programlisting><![CDATA[conn roadwarrior 
]]><![CDATA[left=%any 
]]><![CDATA[right=(ip_of_remote_system) 
]]><![CDATA[rightca="C=FJ, ST=Fiji, L=Suva, O=SOPAC, OU=ICT, CN=SOPAC Root"
]]><![CDATA[network=auto 
]]><![CDATA[auto=start 
]]><![CDATA[pfs=yes
]]><![CDATA[
]]><![CDATA[conn roadwarrior-net 
]]><![CDATA[left=%any 
]]><![CDATA[right=(ip_of_remote_system) 
]]><![CDATA[rightsubnet=(your_subnet)/(your_netmask)
]]><![CDATA[rightca="C=FJ, ST=Fiji, L=Suva, O=SOPAC, OU=ICT, CN=SOPAC Root" 
]]><![CDATA[network=auto 
]]><![CDATA[auto=start 
]]><![CDATA[pfs=yes
]]></programlisting><para>Start the link</para><para>Run the command 'ipsec.exe'. Here's example output:</para><programlisting><![CDATA[C:\ipsec>ipsec 
]]><![CDATA[IPSec Version 2.1.4 (c) 2001,2002 Marcus Mueller 
]]><![CDATA[Getting running Config ... 
]]><![CDATA[Microsoft's Windows XP identified 
]]><![CDATA[Host name is: (local_hostname) 
]]><![CDATA[No RAS connections found. 
]]><![CDATA[LAN IP address: (local_ip_address) 
]]><![CDATA[Setting up IPSec ...
]]><![CDATA[
]]><![CDATA[Deactivating old policy... 
]]><![CDATA[Removing old policy...
]]><![CDATA[
]]><![CDATA[Connection roadwarrior: 
]]><![CDATA[MyTunnel : (local_ip_address)
]]><![CDATA[MyNet : (local_ip_address)/255.255.255.255 
]]><![CDATA[PartnerTunnel: (ip_of_remote_system) 
]]><![CDATA[PartnerNet : (ip_of_remote_system)/255.255.255.255 
]]><![CDATA[CA (ID) : C=FJ, ST=Fiji, L=Suva, O=SOPAC, OU=ICT, CN=SOPAC Root... 
]]><![CDATA[PFS : y 
]]><![CDATA[Auto : start 
]]><![CDATA[Auth.Mode : MD5 
]]><![CDATA[Rekeying : 3600S/50000K 
]]><![CDATA[Activating policy...
]]><![CDATA[
]]><![CDATA[Connection roadwarrior-net: 
]]><![CDATA[MyTunnel : (local_ip_address) 
]]><![CDATA[MyNet : (local_ip_address)/255.255.255.255 
]]><![CDATA[PartnerTunnel: (ip_of_remote_system) 
]]><![CDATA[PartnerNet : (remote_subnet)/(remote_netmask) 
]]><![CDATA[CA (ID) : C=FJ, ST=Fiji, L=Suva, O=SOPAC, OU=ICT, CN=SOPAC Root... 
]]><![CDATA[PFS : y 
]]><![CDATA[Auto : start 
]]><![CDATA[Auth.Mode : MD5 
]]><![CDATA[Rekeying : 3600S/50000K 
]]><![CDATA[Activating policy...
]]><![CDATA[C:\ipsec>
]]></programlisting><para>Now, ping your gateway host. It should say 'Negotiating IP Security' a few times, and then give you ping responses. Note that this may take a few tries; from a T1 hitting a VPN server on a cable modem, it usually takes 3-4 pings. Do the same for the internal network on the remote end, and you should be up!</para></sect3>
</sect2>
</sect1>
</chapter>
<chapter><title>Global PKI</title><sect1><title>Current PKIs</title><para>At the moment you have the choice between a commercial PKI or your own PKI. The commercial PKI were created at the beginning to enable secure commerce over the Internet, basically securing HTTP. The pricing of certificates was calculated on a per host basis. The cost is more expensive than for a domain name because of the costs to identify the owner of the certificate (tracability), but also as a percentage into your e-commerce profits. Unfortunately this vision of a host basis has some major limitations. It is still acceptable to have a certificate to secure POP, IMAP, and other protocols, but when you need a certificate for each e-mail box on your network, costs start to skyrocket as well as the administrative burden to register all these certificates to the Certificate Authority and that every year. This problems exists too if you want to use certificates to authenticate clients in client/server applications (Web server, IPsec,..)</para><para>Why not have a certificate that can sign other certificates? At the moment the only option is to build your own Certificate Authority as described in this document. This allows flexible management of certificates but is limited to the people in your organisation, because people outside your organisation will have to load your root CA certificate to allow smooth operations.</para><para>The solution an unique PKI managed by a central authority in a similar format as DNS is managed. This is called a Global PKI.</para></sect1>
<sect1><title>The need for a Global PKI</title><para>In these days and age security on personnal computers has become important, such importance that Bill Gates stated that when Microsoft will have to choose between features and security, they will now choose security.</para><para>This reflections came from the increasing numbers of rogue people on the Internet. Anybody can send you anything, or trick you in installing anything on your computer. The solution is to identify everybody so when you have a problem you can at least blame someone. This is particulary true in the case of SPAM. It is often difficult to find the originator of an unsolicited e-mail and worse to be able to do something to stop this person. What many people have called for is tracability. If you receive some information which is not traceable through a certificate, you may decide to treat this information differently. This is the same concept as caller ID on telephone network. Certifcates offer this capaility for all applicationson the Internet, e-mails (S/MIME), Commerce transactions (HTTPS), Software install (Code Signing),... Unfortunately certificates are not widely used because they cost a lot if they have to be fully deployed. How many users on Yahoo mail, Hotmail, CA Online, can afford an e-mail certificate? There are some scheme to offer free e-mails certificates, but they can only certify that an e-mail address exists, they can trace back to a human or a body in the real world.</para><para>A global PKI is needed. All the protocols and standards exist, not need to reinvent the wheel. The <ulink url="http://www.ietf.org/">IETF</ulink> has all the mechanice worked out. An LDAP server can store the certificates, a DNS server can reference entry back to certificate stores, HTTP can deliver certificate to applications, S/MIME can secure e-mails,... The problem is now a policy problem or rather a profile problem: select which pieces of this standard should be used to cooperate into a global PKI. Which organisation should provide such service? What level of security/tracability will be achieved?... If one can answer these questions, it will be a step in the right direction and if users buy in, then problem solved...</para><para>I will keep updated this chapter as the work of the working group on PKI of the <ulink url="http://www.isoc.org/">Internet Society</ulink> progress. The Internet Society is also managing the .org Top Level Domain name, so they have a lot of capabilities at hand to solve this e-mail spamming problem.</para></sect1>
</chapter>


</book>
